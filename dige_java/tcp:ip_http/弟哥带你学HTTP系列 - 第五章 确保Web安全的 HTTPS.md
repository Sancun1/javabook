## 公众号：“弟哥带你进大厂”，让你知识成体系的公众号，一定要关注，我们一起进大厂

# HTTP 的缺点 

HTTP 主要有这些不足，例举如下。 

● 通信使用明文（不加密），内容可能会被窃听 

● 不验证通信方的身份，因此有可能遭遇伪装 

● 无法证明报文的完整性，所以有可能已遭篡改 

## 通信使用明文可能会被窃听 

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/80897f0f4da046898f50db385983ddda~tplv-k3u1fbpfcp-zoom-1.image)

### 加密处理防止被窃听 

在目前大家正在研究的如何防止窃听保护信息的几种对策中，最为 普及的就是加密技术。加密的对象可以有这么几个。 

#### 通信的加密 

一种方式就是将通信加密。HTTP 协议中没有加密机制，但可以通 过和 SSL（Secure Socket Layer，安全套接层）或 TLS（Transport Layer Security，安全层传输协议）的组合使用，加密 HTTP 的通信内容。 用 SSL 建立安全通信线路之后，就可以在这条线路上进行 HTTP 通信了。

与 SSL 组合使用的 HTTP 被称为 HTTPS（HTTP Secure，超文 本传输安全协议）或 HTTP over SSL。 

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b6a39a89eea74de098065f91a7083539~tplv-k3u1fbpfcp-zoom-1.image)

#### 内容的加密 

还有一种将参与通信的内容本身加密的方式。由于 HTTP 协议中没 有加密机制，那么就对 HTTP 协议传输的内容本身加密。即把 HTTP 报 文里所含的内容进行加密处理。 在这种情况下，客户端需要对 HTTP 报文进行加密处理后再发送请求 。

诚然，为了做到有效的内容加密，前提是要求客户端和服务器同时 具备加密和解密机制。主要应用在 Web 服务中。有一点必须引起注意， 由于该方式不同于 SSL 或 TLS 将整个通信线路加密处理，所以内容仍 有被篡改的风险。 




## 不验证通信方的身份就可能遭遇伪装 

HTTP 协议的实现本身非常简单，不论是谁发送过来的请求都会返 回响应，因此不确认通信方，会存在以下各种隐患。 

●无法确定请求发送至目标的 Web 服务器是否是按真实意图返回 响应的那台服务器。有可能是已伪装的 Web 服务器。 

● 无法确定响应返回到的客户端是否是按真实意图接收响应的那个 客户端。有可能是已伪装的客户端。 

● 无法确定正在通信的对方是否具备访问权限。因为某些 Web 服 务器上保存着重要的信息，只想发给特定用户通信的权限。 

● 无法判定请求是来自何方、出自谁手。 

● 即使是无意义的请求也会照单全收。无法阻止海量请求下的 DoS 攻击（Denial of Service，拒绝服务攻击）。 

### 查明对手的证书 

虽然使用 HTTP 协议无法确定通信方，但如果使用 SSL 则可以。 SSL 不仅提供加密处理，而且还使用了一种被称为证书的手段，可用于 确定方。 

证书由值得信任的第三方机构颁发，用以证明服务器和客户端是实 际存在的。另外，伪造证书从技术角度来说是异常困难的一件事。所以 只要能够确认通信方（服务器或客户端）持有的证书，即可判断通信方 的真实意图。 

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7472e15c4e6145e5a185d6c1026835a9~tplv-k3u1fbpfcp-zoom-1.image)

通过使用证书，以证明通信方就是意料中的服务器。这对使用者个 人来讲，也减少了个人信息泄露的危险性。 另外，客户端持有证书即可完成个人身份的确认，也可用于对 Web 网站的认证环节。 

## 无法证明报文完整性，可能已遭篡改 

从某个 Web 网站上下载内容，是无法确定客户端下载的文 件和服务器上存放的文件是否前后一致的。文件内容在传输途中可能已 经被篡改为其他的内容。即使内容真的已改变，作为接收方的客户端也 是觉察不到的。 

### 如何防止篡改 

虽然有使用 HTTP 协议确定报文完整性的方法，但事实上并不便 捷、可靠。其中常用的是 MD5 和 SHA-1 等散列值校验的方法，以及用 来确认文件的数字签名方法。 

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6b0d2e5eafba4291846d2a8a6e0eba3a~tplv-k3u1fbpfcp-zoom-1.image)

提供文件下载服务的 Web 网站也会提供相应的以 PGP（Pretty Good Privacy，完美隐私）创建的数字签名及 MD5 算法生成的散列值。PGP 是用来证明创建文件的数字签名，MD5 是由单向函数生成的散列值。 

不论使用哪一种方法，都需要操纵客户端的用户本人亲自检查验证下载 的文件是否就是原来服务器上的文件。浏览器无法自动帮用户检查。 

可惜的是，用这些方法也依然无法百分百保证确认结果正确。因为 PGP 和 MD5 本身被改写的话，用户是没有办法意识到的。 为了有效防止这些弊端，有必要使用 HTTPS。SSL 提供认证和加 密处理及摘要功能。仅靠 HTTP 确保完整性是非常困难的，因此通过和 其他协议组合使用来实现这个目标。下节我们介绍 HTTPS 的相关内容。 

# HTTP+ 加密 + 认证 + 完整性保护 =HTTPS 

## HTTP 加上加密处理和认证以及完整性保护后即是 HTTPS 

对于 HTTP 来说，服务器也好，客户端也好，都是没有办法 确认通信方的。因为很有可能并不是和原本预想的通信方在实际通信。 并且还需要考虑到接收到的报文在通信途中已经遭到篡改这一可能性。 

为了统一解决上述这些问题，需要在 HTTP 上再加入加密处理和认证等 机制。我们把添加了加密及认证机制的 HTTP 称为 HTTPS（HTTP Secure）。 

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/59e734af6b4042279e2a43012ae72299~tplv-k3u1fbpfcp-zoom-1.image)

当浏览器 访问 HTTPS 通信有效的 Web 网站时，浏览器的地址栏内会出现一个带 锁的标记。对 HTTPS 的显示方式会因浏览器的不同而有所改变。 

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/111caf384fb8402e9dbb18a73178019e~tplv-k3u1fbpfcp-zoom-1.image)

## HTTPS 是身披 SSL 外壳的 HTTP 

HTTPS 并非是应用层的一种新协议。只是 HTTP 通信接口部分用 SSL（Secure Socket Layer）和 TLS（Transport Layer Security）协议代替 而已。 

通常，HTTP 直接和 TCP 通信。当使用 SSL 时，则演变成先和 SSL 通信，再由 SSL 和 TCP 通信了。简言之，所谓 HTTPS，其实就是 身披 SSL 协议这层外壳的 HTTP。 

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ce387c80f43040c6b8530f50eee442b0~tplv-k3u1fbpfcp-zoom-1.image)

在采用 SSL 后，HTTP 就拥有了 HTTPS 的加密、证书和完整性保 护这些功能。

SSL 是独立于 HTTP 的协议，所以不光是 HTTP 协议，其他运行在 应用层的 SMTP 和 Telnet 等协议均可配合 SSL 协议使用。可以说 SSL 是当今世界上应用最为广泛的网络安全技术。 

## 相互交换密钥的公开密钥加密技术 

在对 SSL 进行讲解之前，我们先来了解一下加密方法。SSL 采用一 种叫做公开密钥加密（Public-key cryptography）的加密处理方式。 

近代的加密方法中加密算法是公开的，而密钥却是保密的。通过这种方式得以保持加密方法的安全性。

加密和解密都会用到密钥。没有密钥就无法对密码解密，反过来说，任何人只要持有密钥就能解密了。如果密钥被攻击者获得。那加密也就失去了意义。 

### 共享密钥加密的困境 

加密和解密同用一个密钥的方式称为共享密钥加密（Common key crypto system），也被叫做对称密钥加密。 

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/25c1ee35effc47199fea97f185dd5cf8~tplv-k3u1fbpfcp-zoom-1.image)

以共享密钥方式加密时必须将密钥也发给对方。可究竟怎样才能安全地转交？在互联网上转发密钥时，如果通信被监听那么密钥就可会落 入攻击者之手，同时也就失去了加密的意义。另外还得设法安全地保管接收到的密钥。 

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/11d51455b05b42e4ab5446a4d9ebc6be~tplv-k3u1fbpfcp-zoom-1.image)

### 使用两把密钥的公开密钥加密 

公开密钥加密方式很好地解决了共享密钥加密的困难。 

公开密钥加密使用一对非对称的密钥。一把叫做私有密钥（private key），另一把叫做公开密钥（public key）。顾名思义，私有密钥不能让 其他任何人知道，而公开密钥则可以随意发布，任何人都可以获得。 

使用公开密钥加密方式，发送密文的一方使用对方的公开密钥进行 加密处理，对方收到被加密的信息后，再使用自己的私有密钥进行解 密。利用这种方式，不需要发送用来解密的私有密钥，也不必担心密钥 被攻击者窃听而盗走。 

另外，要想根据密文和公开密钥，恢复到信息原文是异常困难的， 因为解密过程就是在对离散对数进行求值，这并非轻而易举就能办到。 退一步讲，如果能对一个非常大的整数做到快速地因式分解，那么密码破解还是存在希望的。但就目前的技术来看是不太现实的。 

### HTTPS采用混合加密机制 

HTTPS 采用共享密钥加密和公开密钥加密两者并用的混合加密机制。充分利用两者各自的优势，将多种方法组合起来用于通信。 **在交换密钥环节使用公开密钥加密方式，之后的建立通信交换报文阶段 则使用共享密钥加密方式。**

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/39f041852eac49d081d2d8a393f197ce~tplv-k3u1fbpfcp-zoom-1.image)

### 证明公开密钥正确性的证书 

遗憾的是，公开密钥加密方式还是存在一些问题的。那就是无法证 明公开密钥本身就是货真价实的公开密钥。比如，正准备和某台服务器建立公开密钥加密方式下的通信时，如何证明收到的公开密钥就是原本 预想的那台服务器发行的公开密钥。或许在公开密钥传输途中，真正的 公开密钥已经被攻击者替换掉了.

为了解决上述问题，可以使用由数字证书认证机构（CA，Certificate Authority）和其相关机关颁发的公开密钥证书。 

数字证书认证机构处于客户端与服务器双方都可信赖的第三方机构的立场上。我们来介绍一下数字证书认证机构的业务流程：

-   -   首先，服务器的运营人员向数字证书认证机构提出公开密钥的申请。
    -   数字证书认证机构在判明提出申请者的身份之后，会对已申请的公开密钥做数字签名，然后分配这个已签名的公开密钥，并将该公开密钥放入公钥证书后绑定在一起。 

<!---->

-   -   服务器会将这份由数字证书认证机构颁发的公钥证书发送给客户端，以进行公开密钥加密方式通信。公钥证书也可叫做数字证书或直接称为证书。 
    -   接到证书的客户端可使用数字证书认证机构的公开密钥，对那张证书上的数字签名进行验证，一旦验证通过，客户端便可明确两件事： 一，认证服务器的公开密钥的是真实有效的数字证书认证机构。二，服务器的公开密钥是值得信赖的。 

此处认证机关的公开密钥必须安全地转交给客户端。使用通信方式 时，如何安全转交是一件很困难的事，因此，多数浏览器开发商发布版本时，会事先在内部植入常用认证机关的公开密钥 

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/512de6c1b54440c6bfe549d19cd83896~tplv-k3u1fbpfcp-zoom-1.image)

### 可证明组织真实性的EV SSL证书 

证书的一个作用是用来证明作为通信一方的服务器是否规范，另外 一个作用是可确认对方服务器背后运营的企业是否真实存在。

拥有该特性的证书就是 EV SSL 证书（Extended Validation SSL Certificate）。 EV SSL 证书是基于国际标准的认证指导方针颁发的证书。其严格规定了对运营组织是否真实的确认方针，因此，通过认证的 Web 网站 能够获得更高的认可度。 

持有 EV SSL 证书的 Web 网站的浏览器地址栏处的背景色是绿色的，从视觉上就能一眼辨别出。而且在地址栏的左侧显示了 SSL 证书 中记录的组织名称以及颁发证书的认证机构的名称。 

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/62b21e898df04735b00f67d9e1d181a4~tplv-k3u1fbpfcp-zoom-1.image)

上述机制的原意图是为了防止用户被钓鱼攻击（Phishing），但就效 果上来讲，还得打一个问号。很多用户可能不了解 EV SSL 证书相关的 知识，因此也不太会留意它。 

### 用以确认客户端的客户端证书 

HTTPS 中还可以使用客户端证书。以客户端证书进行客户端认证， 证明服务器正在通信的对方始终是预料之内的客户端，其作用跟服务器 证书如出一辙。 

但客户端证书仍存在几处问题点。其中的一个问题点是证书的获取及发布。 想获取证书时，用户得自行安装客户端证书。但由于客户端证书是要付费购买的，且每张证书对应到每位用户也就意味着需支付和用户数对等的费用。另外，要让知识层次不同的用户们自行安装证书，这件事本身也充满了各种挑战。 

现状是，安全性极高的认证机构可颁发客户端证书但仅用于特殊用 途的业务。比如那些可支撑客户端证书支出费用的业务。

例如，银行的网上银行就采用了客户端证书。在登录网银时不仅要求用户确认输入 ID 和密码，还会要求用户的客户端证书，以确认用户是否从特定的终端访问网银。 

客户端证书存在的另一个问题点是，客户端证书毕竟只能用来证明客户端实际存在，而不能用来证明用户本人的真实有效性。也就是说， 只要获得了安装有客户端证书的计算机的使用权限，也就意味着同时拥 有了客户端证书的使用权限。 

# HTTPS 的安全通信机制 

为了更好地理解 HTTPS，我们来观察一下 HTTPS 的通信步骤。 

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0db2362276684c72b51ee0bc404376b6~tplv-k3u1fbpfcp-zoom-1.image)

1.  客户端通过发送 Client Hello 报文开始 SSL 通信。报文中包含客户端支持的 SSL 的指定版本、加密组件（Cipher Suite）列表（所使用的加密算法及密钥长度等）。 
1.  服务器可进行 SSL 通信时，会以 Server Hello 报文作为应答。和客户端一样，在报文中包含 SSL 版本以及加密组件。服务器的加密组件内容是从接收到的客户端加密组件内筛选出来的。

<!---->

3.  之后服务器发送 Certificate 报文。报文中包含公开密钥证书。 
3.  最后服务器发送 Server Hello Done 报文通知客户端，最初阶段的 SSL 握手协商部分结束。 

<!---->

5.  SSL 第一次握手结束之后，客户端以 Client Key Exchange 报文作为回应。报文中包含通信加密中使用的一种被称为 Pre-master secret 的随机密码串。该报文已用步骤 3 中的公开密钥进行加密。 
5.  接着客户端继续发送 Change Cipher Spec 报文。该报文会提示服务器，在此报文之后的通信会采用 Pre-master secret 密钥加密。 

<!---->

7.  客户端发送 Finished 报文。该报文包含连接至今全部报文的整体校验值。这次握手协商是否能够成功，要以服务器是否能够正确解密该报文作为判定标准。 
7.  服务器同样发送 Change Cipher Spec 报文。 

<!---->

9.  服务器同样发送 Finished 报文。 
9.  服务器和客户端的 Finished 报文交换完毕之后，SSL 连接就算建立完成。当然，通信会受到 SSL 的保护。从此处开始进行应用层协议的通信，即发送 HTTP 请求。 

<!---->

11. 应用层协议通信，即发送 HTTP 响应。 
11. 最后由客户端断开连接。断开连接时，发送 close_notify 最后由客户端断开连接。断开连接时，发送 close_notify 



在以上流程中，应用层发送数据时会附加一种叫做 MAC（Message Authentication Code）的报文摘要。MAC 能够查知报文是否遭到篡改， 从而保护报文的完整性。 

下面是对整个流程的图解。图中说明了从仅使用服务器端的公开密 钥证书（服务器证书）建立 HTTPS 通信的整个过程。 

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0ae9f4d2e3ea44e8a074f39282373052~tplv-k3u1fbpfcp-zoom-1.image)

